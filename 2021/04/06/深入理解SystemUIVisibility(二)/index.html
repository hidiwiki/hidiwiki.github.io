<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>深入理解SystemUiVisibility(二) | 哈哈迪的小站</title>
  <meta name="keywords" content=" WMS , SystemUI ">
  <meta name="description" content="深入理解SystemUiVisibility(二) | 哈哈迪的小站">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="[TOC] DataBinding的基本使用一、基本概念下面通过一个示例来说明DataBinding的作用 一个简单的示例：画面内有一个Button和一个TextView，每次点击Button，TextView数字加1，布局如下： 二、传统实现使用ViewModel来存放界面的数据，ViewModel的代码如下 public class MainViewModel extends ViewMode">
<meta property="og:type" content="article">
<meta property="og:title" content="DataBinding的基本使用">
<meta property="og:url" content="http://hidiwiki.github.io/2021/10/17/DataBinding%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="哈哈迪的小站">
<meta property="og:description" content="[TOC] DataBinding的基本使用一、基本概念下面通过一个示例来说明DataBinding的作用 一个简单的示例：画面内有一个Button和一个TextView，每次点击Button，TextView数字加1，布局如下： 二、传统实现使用ViewModel来存放界面的数据，ViewModel的代码如下 public class MainViewModel extends ViewMode">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/45f179a0902d44dd8d8285b844a076fd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAaGlkaV93aWtp,size_9,color_FFFFFF,t_70,g_se,x_16#pic_center">
<meta property="article:published_time" content="2021-10-17T11:49:52.000Z">
<meta property="article:modified_time" content="2021-10-17T12:03:28.540Z">
<meta property="article:author" content="Liu Haidi">
<meta property="article:tag" content="MVVM">
<meta property="article:tag" content="DataBinding">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/45f179a0902d44dd8d8285b844a076fd.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAaGlkaV93aWtp,size_9,color_FFFFFF,t_70,g_se,x_16#pic_center">


<link rel="icon" href="/img/dog.png">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 5.4.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="false" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/dog.png"/>
</a>
<div class="author">
    <span>Liu Haidi</span>
</div>

<div class="icon">
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            <a title="email"
               href="mailto:liu_haidy@163.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=1099924038&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(6)</small>
            
        </div>
    </li>
    
        
            
        
    
        
            
                <li>
                    <div data-rel="android">
                        <i class="fold iconfont icon-right"></i>
                        
                        android
                        <small>(4)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="android<--->架构组件">
                                        
                                        架构组件
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="6">
<input type="hidden" id="yelog_site_word_count" value="6.7k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://hidiwiki.github.io/">wiki</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Activity</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>AMS</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>DataBinding</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>MVVM</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SystemUI</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>WMS</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="全部文章 android 架构组件 "
           href="/2021/10/17/DataBinding%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"
           data-tag="MVVM,DataBinding"
           data-author="" >
            <span class="post-title" title="DataBinding的基本使用">DataBinding的基本使用</span>
            <span class="post-date" title="2021-10-17 19:49:52">2021/10/17</span>
        </a>
        
        <a  class="全部文章 "
           href="/2021/08/15/%E6%88%91%E7%9A%84%E5%8D%9A%E5%AE%A2/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="我的博客">我的博客</span>
            <span class="post-date" title="2021-08-15 15:09:52">2021/08/15</span>
        </a>
        
        <a  class="全部文章 "
           href="/2021/08/15/hello-world/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Hello World">Hello World</span>
            <span class="post-date" title="2021-08-15 12:58:31">2021/08/15</span>
        </a>
        
        <a  class="全部文章 android "
           href="/2021/04/24/Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90(%E4%BA%8C)/"
           data-tag="AMS,WMS,Activity"
           data-author="" >
            <span class="post-title" title="Activity的动流程分析(二)">Activity的动流程分析(二)</span>
            <span class="post-date" title="2021-04-24 16:00:00">2021/04/24</span>
        </a>
        
        <a  class="全部文章 android "
           href="/2021/04/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3SystemUIVisibility(%E4%BA%8C)/"
           data-tag="WMS,SystemUI"
           data-author="" >
            <span class="post-title" title="深入理解SystemUiVisibility(二)">深入理解SystemUiVisibility(二)</span>
            <span class="post-date" title="2021-04-06 16:13:47">2021/04/06</span>
        </a>
        
        <a  class="全部文章 android "
           href="/2021/04/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3SystemUiVisibility(%E4%B8%80)/"
           data-tag="WMS,SystemUI"
           data-author="" >
            <span class="post-title" title="深入理解SystemUiVisibility(一)">深入理解SystemUiVisibility(一)</span>
            <span class="post-date" title="2021-04-06 16:13:47">2021/04/06</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-深入理解SystemUIVisibility(二)" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">深入理解SystemUiVisibility(二)</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="android">android</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color4">WMS</a>
            
            <a class="color4">SystemUI</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2021-08-21 11:44:04'>2021-04-06 16:13</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:1.2k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3SystemUIVisibility-%E4%BA%8C"><span class="toc-text">深入理解SystemUIVisibility(二)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%8E%A7%E4%BB%B6%E6%A0%91%E8%AE%BE%E7%BD%AESystemUIVisibility"><span class="toc-text">一、控件树设置SystemUIVisibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81WMS%E8%B0%83%E6%95%B4SystemUIVisibility"><span class="toc-text">二、WMS调整SystemUIVisibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81SystemUI%E5%A4%84%E7%90%86SystemUIVisibility"><span class="toc-text">三、SystemUI处理SystemUIVisibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81WMS%E6%9B%B4%E6%96%B0SystemUIVisibility%E8%87%B3%E6%8E%A7%E4%BB%B6%E6%A0%91"><span class="toc-text">四、WMS更新SystemUIVisibility至控件树</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><div class='inner-toc'><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3SystemUIVisibility-%E4%BA%8C"><span class="toc-text">深入理解SystemUIVisibility(二)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%8E%A7%E4%BB%B6%E6%A0%91%E8%AE%BE%E7%BD%AESystemUIVisibility"><span class="toc-text">一、控件树设置SystemUIVisibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81WMS%E8%B0%83%E6%95%B4SystemUIVisibility"><span class="toc-text">二、WMS调整SystemUIVisibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81SystemUI%E5%A4%84%E7%90%86SystemUIVisibility"><span class="toc-text">三、SystemUI处理SystemUIVisibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81WMS%E6%9B%B4%E6%96%B0SystemUIVisibility%E8%87%B3%E6%8E%A7%E4%BB%B6%E6%A0%91"><span class="toc-text">四、WMS更新SystemUIVisibility至控件树</span></a></li></ol></li></ol></div></p>
<h1 id="深入理解SystemUIVisibility-二"><a href="#深入理解SystemUIVisibility-二" class="headerlink" title="深入理解SystemUIVisibility(二)"></a>深入理解SystemUIVisibility(二)</h1><p>在深入理解SystemUIVisiblity(一)中，介绍了SystemUI的属性的基本定义，本章将对SystemUIVisibility在系统中的调用过程进行分析，探索其消费过程，从整体来看，其调用过程可以划分为如下四个阶段</p>
<ol>
<li> 控件树设置SystemUIVisibility</li>
<li> WMS调整SystemUIVisibility</li>
<li> SystemUI处理SystemUIVisibility，并通知WMS</li>
<li> WMS更新SystemUIVisibility至控件树</li>
</ol>
<p>大致的流程可以参考一下模块交互图</p>
<p><img src="/img/pic/systemUI_2/SystemUIVisibility%E4%BA%A4%E4%BA%92%E5%9B%BE.png" alt="SystemUIVisibility交互图"></p>
<h2 id="一、控件树设置SystemUIVisibility"><a href="#一、控件树设置SystemUIVisibility" class="headerlink" title="一、控件树设置SystemUIVisibility"></a>一、控件树设置SystemUIVisibility</h2><ol>
<li><p> 各个控件通过View提供的接口<strong>setSystemUiVisibility()<strong>把<code>systemUIVisibility</code>设置进来，然后在更新到ViewRootImpl中,更新的方法为</strong>recomputeViewAttributes()</strong></p>
</li>
<li><p>**recomputeViewAttributes()**会沿着控件树向根部回溯，会触发一次遍历动作</p>
<pre><code class="java">@Override
public void recomputeViewAttributes(View child) &#123;
    checkThread();
    if (mView == child) &#123;
        mAttachInfo.mRecomputeGlobalAttributes = true;
        if (!mWillDrawSoon) &#123;
            scheduleTraversals(); // 触发一次遍历
        &#125;
    &#125;
&#125;
</code></pre>
</li>
<li><p> 在遍历的过程中，ViewRootImpl会收集控件树内所有View所期望的mSystemUIVisibility属性，并将其记录在AttachInfo.mSystemUiVisibility中，并保存到当前窗口的LayoutParams.subtreeSystemUiVisibility中，作为本窗口所期望的SystemUiVisibility,然后再通过调用WMS的relayoutWindow(), 将LayoutParams.systemUiVisibility 和LayoutParams.subtreeSystemUiVisibility 一同更新到WMS中</p>
</li>
</ol>
<p>调用时序图如下所示</p>
<p><img src="/img/pic/systemUI_2/View-_WMS.png" alt="View-_WMS"></p>
<h2 id="二、WMS调整SystemUIVisibility"><a href="#二、WMS调整SystemUIVisibility" class="headerlink" title="二、WMS调整SystemUIVisibility"></a>二、WMS调整SystemUIVisibility</h2><p>一个窗口所期望的SystemUiVisibility通过调用WMS.relayoutWindow()方法将SystemUiVisibility属性更新进WMS，在该方法中，有两步比较重要：</p>
<ol>
<li> 将从控件树中收集的subtreeSystemUiVisibility 和 systemUiVisibility进行整合</li>
<li> 将其更新到控件树所在Window的mSystemUiVisibility中</li>
</ol>
<pre><code class="java">public int relayoutWindow(Session session, IWindow client, int seq, LayoutParams attrs,
                          int requestedWidth, int requestedHeight, int viewVisibility,
                          int flags,long frameNumber, Rect outFrame,
                          Rect outOverscanInsets, Rect outContentInsets,
                          Rect outVisibleInsets, Rect outStableInsets, 
                          Rect outOutsets, Rect outBackdropFrame,
                          DisplayCutout.ParcelableWrapper outCutout, 
                          MergedConfiguration mergedConfiguration,
                          Surface outSurface) &#123;
            ......
            
            mPolicy.adjustWindowParamsLw(win, attrs, hasStatusBarServicePermission);
            // if they don&#39;t have the permission, mask out the status bar bits
            if (seq == win.mSeq) &#123;
                // 将从控件树中收集的subtreeSystemUiVisibility 和
                // systemUiVisibility进行整合
                int systemUiVisibility = attrs.systemUiVisibility
                    | attrs.subtreeSystemUiVisibility;
                if ((systemUiVisibility &amp; DISABLE_MASK) != 0) &#123;
                    if (!hasStatusBarPermission) &#123;
                        systemUiVisibility &amp;= ~DISABLE_MASK;
                    &#125;
                &#125;
                // 将其更新到win.mSystemUiVisibility
                win.mSystemUiVisibility = systemUiVisibility;
            &#125;
             ......

&#125;
</code></pre>
<p>SystemUiVisibility 的一个消费者有是WMS的军师PhoneWindowManager， PhoneWindowManager可以通过WindowState.getSystemUiVisibility()对窗口进行布局，显示和隐藏statue bar 和 navigation bar</p>
<p>除了PWM，SystemUiVisibility 的另一个消费者是SystemUi中的StatusBar，WMS不会像ViewRootImpl一样收集所有窗口的systemUiVisibility，然后将他们整合在一起，而是将焦点窗口的SystemUiVisibility 传递给StatusBar, 传递的实机有两个，一是当窗口焦点发生变化时，调用PWM.focusChangedLw()，另一个是在WMS在布局过程中调用PWM.finishPostLayoutLw()，这两个方法都会调用PWM.updateSystemUiVisibilityLw()，将焦点窗口的SystemUiVisibility 传递给SystemUi，PWM.updateSystemUiVisibilityLw()代码如下</p>
<pre><code class="java">private int updateSystemUiVisibilityLw() &#123;
    // If there is no window focused, there will be nobody to handle the events
    // anyway, so just hang on in whatever state we&#39;re in until things settle down.
    WindowState winCandidate = mFocusedWindow != null ? mFocusedWindow
        : mTopFullscreenOpaqueWindowState;
    
    ......
    
    final WindowState win = winCandidate;
    
    ......
    // 从焦点窗口中获取它所期望的SystemUiVisibility
    int tmpVisibility = PolicyControl.getSystemUiVisibility(win, null)
        &amp; ~mResettingSystemUiFlags
        &amp; ~mForceClearedSystemUiFlags;

    ......
    
    // 将过滤后的SystemUiVisibility更新到PWM.mLastSystemUiFlags中
    mLastSystemUiFlags = visibility;

    ......
    
    mHandler.post(new Runnable() &#123;
        @Override
        public void run() &#123;
            StatusBarManagerInternal statusbar = getStatusBarManagerInternal();
            if (statusbar != null) &#123;
                // 将SystemUIVisibility设置给SystemUi进程中StatusBar
                statusbar.setSystemUiVisibility(visibility, fullscreenVisibility,
                                                dockedVisibility, 0xffffffff, 
                                                fullscreenStackBounds,
                                                dockedStackBounds, win.toString());
                statusbar.topAppWindowChanged(needsMenu);
            &#125;
        &#125;
    &#125;);
    return diff;
&#125;
</code></pre>
<p>调用过程总结如下:</p>
<p><img src="/img/pic/systemUI_2/WMS-_SBMS.png" alt="WMS-&gt;SBMS"></p>
<p>WMS 会通过StatusBarManagerService与SystemUi进程进行交互，SystemUI通过CommandQueue与WMS进行交互，大致流程如下：SystemUI进程起来后，会在内部创建CommandQueue对象， 该对象继承IStatueBar.Stub， 可以进行跨进程通信，创建完成后，在StatusBar.start()方法中，会将其注册到StatusBarManagerService中， 这样WMS就保存了SystemUi的binder对象， 用于回调SystemUI的方法，各个类之间的关系如下：</p>
<p><img src="/img/pic/systemUI_2/SystemUI%E7%B1%BB%E5%9B%BE.png" alt="SystemUI类图"></p>
<h2 id="三、SystemUI处理SystemUIVisibility"><a href="#三、SystemUI处理SystemUIVisibility" class="headerlink" title="三、SystemUI处理SystemUIVisibility"></a>三、SystemUI处理SystemUIVisibility</h2><p>在SystemUI进程中， 由StatusBar.</p>
<pre><code class="java">public void setSystemUiVisibility(int vis, int fullscreenStackVis, int dockedStackVis,
                                  int mask, Rect fullscreenStackBounds,
                                  Rect dockedStackBounds) &#123;
    final int oldVal = mSystemUiVisibility;
    final int newVal = (oldVal&amp;~mask) | (vis&amp;mask);
    final int diff = newVal ^ oldVal;

    ......
    
    boolean sbModeChanged = false;
    if (diff != 0) &#123;
        // 将运算后的新的newVal更新到mSystemUiVisibility
        mSystemUiVisibility = newVal;

        // 更新低调模式
        if ((diff &amp; View.SYSTEM_UI_FLAG_LOW_PROFILE) != 0) &#123;
            setAreThereNotifications();
        &#125;

        ......

        // 将运算后新的mSystemUiVisibility通知WindowManager，再更新的各个Window的控件树中
        notifyUiVisibilityChanged(mSystemUiVisibility);
    &#125;

    mLightBarController.onSystemUiVisibilityChanged(fullscreenStackVis, dockedStackVis,
                                                    mask, fullscreenStackBounds, dockedStackBounds, sbModeChanged, mStatusBarMode);
&#125;
</code></pre>
<p>调用过程比较简单，在此不再分析，具体调用过程如下：</p>
<p><img src="/img/pic/systemUI_2/StatusBar-View.png" alt="StatusBar-View"></p>
<h2 id="四、WMS更新SystemUIVisibility至控件树"><a href="#四、WMS更新SystemUIVisibility至控件树" class="headerlink" title="四、WMS更新SystemUIVisibility至控件树"></a>四、WMS更新SystemUIVisibility至控件树</h2><p>StatusBar 会将PWM传递过来的SystemUIVisibility保存到mSystemUiVisibility，然后又调用notifyUiVisibilityChanged()将mSystemUiVisibility通知给WMS， WMS对于mSystemUiVisibility的处理如下：</p>
<pre><code class="java">@Override
public void statusBarVisibilityChanged(int visibility) &#123;
    if (mContext.checkCallingOrSelfPermission(android.Manifest.permission.STATUS_BAR)
        != PackageManager.PERMISSION_GRANTED) &#123;
        throw new SecurityException(&quot;Caller does not hold permission &quot;
                                    + android.Manifest.permission.STATUS_BAR);
    &#125;

    synchronized (mWindowMap) &#123;
        mLastStatusBarVisibility = visibility;
        visibility = mPolicy.adjustSystemUiVisibilityLw(visibility);
        // 将修正后的visibility更新到各个窗口
        updateStatusBarVisibilityLocked(visibility);
    &#125;
&#125;
</code></pre>
<p>在WMS中，会将visibility传递给PWM，在PWM中会清除mForceClearingStatusBarVisibility 以及 mResettingSystemUiFlags 中的标记</p>
<pre><code class="java">@Override
public int adjustSystemUiVisibilityLw(int visibility) &#123;
    mStatusBarController.adjustSystemUiVisibilityLw(mLastSystemUiFlags, visibility);
    mNavigationBarController.adjustSystemUiVisibilityLw(mLastSystemUiFlags, visibility);

    // Reset any bits in mForceClearingStatusBarVisibility that
    // are now clear.
    mResettingSystemUiFlags &amp;= visibility;
    // Clear any bits in the new visibility that are currently being
    // force cleared, before reporting it.
    return visibility &amp; ~mResettingSystemUiFlags
        &amp; ~mForceClearedSystemUiFlags;
&#125;
</code></pre>
<p>在更新完visibility后， WMS将visibility更新到各个控件树中，至此，mSystemUiVisibility在系统中的处理过程分析完毕，中间省略了很多细节，后续文章继续补充</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 liu_haidy@163.com </span>
    </div>
</article>







    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2016-2021 liuhaidi
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().trim().split('\n').length, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
        /* 渲染*/
        function HTMLDecode(text) {
            var temp = document.createElement("div");
            temp.innerHTML = text;
            var output = temp.innerText || temp.textContent;
            temp = null;
            return output;
        }
        if (window.mermaid){
            window.mermaid = null
        }
        $.getScript("//cdn.jsdelivr.net/npm/mermaid@8.4.2/dist/mermaid.min.js", function () {
            var mermaidOptions = JSON.parse(HTMLDecode("{&#34;theme&#34;:&#34;default&#34;,&#34;startOnLoad&#34;:true,&#34;flowchart&#34;:{&#34;useMaxWidth&#34;:false,&#34;htmlLabels&#34;:true}}"))
            if (window.mermaid) {
                mermaid.initialize(mermaidOptions)
                mermaid.contentLoaded()
            }
        })
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: #fafafa;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 572px;
    }
    .nav.fullscreen {
        margin-left: -572px;
    }
    .nav-left {
        width: 150px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    #post {
        background: url(/img/bg.jpg);
    }
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
